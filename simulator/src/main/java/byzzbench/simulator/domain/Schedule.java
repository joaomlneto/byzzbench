package byzzbench.simulator.domain;

import byzzbench.simulator.Scenario;
import byzzbench.simulator.ScenarioPredicate;
import byzzbench.simulator.transport.Event;
import byzzbench.simulator.transport.MessageEvent;
import byzzbench.simulator.transport.TimeoutEvent;
import byzzbench.simulator.utils.NonNull;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import io.hypersistence.utils.hibernate.type.json.JsonType;
import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.Type;

import java.io.Serializable;
import java.util.*;

/**
 * Represents a schedule of events that can be executed by the simulator.
 */
@JsonIgnoreProperties(ignoreUnknown = true)
@Entity
@NoArgsConstructor
@Data
public class Schedule implements Serializable {
    /**
     * The unique identifier of the schedule.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private long scheduleId;

    /**
     * A human-readable name/description for the schedule.
     */
    private String name;

    /**
     * The initial parameters of the scenario that generated this schedule.
     */
    @Type(JsonType.class)
    @Column(columnDefinition = "json")
    private ScenarioParameters parameters;

    /**
     * The list of actions in the schedule
     */
    @NonNull
    @OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER, mappedBy = "schedule")
    private List<Action> actions = new ArrayList<>();

    @ManyToOne
    @JsonIgnore
    private Campaign campaign;

    /**
     * The set of invariants that are violated by this schedule.
     */
    @NonNull
    @Transient
    private SortedSet<ScenarioPredicate> brokenInvariants = new TreeSet<>();

    /**
     * The scenario generated by this schedule (may be null if not generated).
     */
    @JsonIgnore
    @Transient
    private transient Scenario scenario;

    /**
     * Creates a new schedule for the given scenario.
     *
     * @param parameters the initial parameters of the scenario that generated this schedule.
     */
    public Schedule(ScenarioParameters parameters) {
        this.parameters = parameters;
    }

    public void appendEvent(Event event) {
        switch (event) {
            case MessageEvent messageEvent -> appendAction(DeliverMessageAction.builder()
                    .messageEventId(event.getEventId())
                    .recipientId(messageEvent.getRecipientId())
                    .senderId(messageEvent.getSenderId())
                    .timestamp(messageEvent.getCreatedAt())
                    .payload(messageEvent.getPayload())
                    .schedule(this)
                    .build());
            case TimeoutEvent timeoutEvent -> appendAction(TriggerTimeoutAction.builder()
                    .timeoutEventId(timeoutEvent.getEventId())
                    .timeout(timeoutEvent.getTimeout())
                    .schedule(this)
                    .build());
            default -> throw new IllegalArgumentException("Unsupported event type: " + event.getClass().getName());
        }
    }

    /**
     * Appends the given action to the schedule.
     *
     * @param action the action to append.
     */
    public void appendAction(Action action) {
        actions.add(action);
    }

    /**
     * Marks the schedule as read-only, with the given broken invariants.
     *
     * @param brokenInvariants the set of broken invariants.
     */
    public void finalizeSchedule(Set<ScenarioPredicate> brokenInvariants) {
        this.brokenInvariants.addAll(brokenInvariants);
    }

    /**
     * Returns true if the schedule is buggy, i.e., it violates some invariants.
     *
     * @return true if the schedule is buggy, false otherwise.
     */
    @JsonIgnore
    public boolean isBuggy() {
        return !brokenInvariants.isEmpty();
    }

    /**
     * Returns the id of the scenario that generated this schedule.
     *
     * @return the id of the scenario that generated this schedule.
     */
    public @NonNull Scenario getScenario() {
        if (this.scenario == null) {
            throw new IllegalStateException("No scenario set for this schedule");
        }
        return this.scenario;
    }

    /**
     * Returns the length of the schedule, i.e., the number of actions in it.
     *
     * @return the length of the schedule.
     */
    public int getLength() {
        return this.actions.size();
    }

    public boolean isMaterialized() {
        return this.scenario != null;
    }

    /**
     * Method executed after the entity is loaded into the persistence context.
     * This method attempts to initialize the `scenario` field by fetching the
     * corresponding scenario from the ScenarioService using the schedule ID.
     * If no scenario is found for the given schedule ID, the `scenario` field
     * remains unset.
     */
    /*
     * This is no longer needed, since all schedules are memorized in the ScenarioService
     * if they have a scenario materialized!
    @PostLoad
    public void onLoad() {
        try {
            this.scenario = Optional.of(ApplicationContextProvider.getScenarioService().getScenarioById(this.getScheduleId()));
            System.out.println("Found scenario for schedule " + this.scheduleId);
        } catch (NoSuchElementException e) {
            System.out.println("No scenario found for schedule " + this.scheduleId);
            // ignore - scenario not materialized
        }
    }*/
}
