name: Build Docker Image

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - "*"

jobs:
  build:
    name: Build, Test and Package Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21
          #check-latest: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: ./gradlew build

      #- name: Login to GitHub Container Registry
      #  uses: docker/login-action@v3
      #  with:
      #    registry: ghcr.io
      #    username: ${{ github.actor }}
      #    password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test gradle
        run: |
          ./gradlew test

      # Ensure OpenAPI spec is generated for the WebUI codegen step
      - name: Generate OpenAPI spec
        run: ./gradlew generateOpenApiDocs

      # Build the Web UI to ensure it still compiles successfully
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: 'webui/pnpm-lock.yaml'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install WebUI dependencies
        working-directory: webui
        run: |
          pnpm install --frozen-lockfile

      - name: Generate WebUI API client from OpenAPI
        run: |
          cp simulator/build/openapi.json webui/openapi.json
          cd webui
          pnpm run kubb:generate -- ./openapi.json

      - name: Build WebUI
        working-directory: webui
        run: |
          pnpm run build

      - name: Build container image with gradle, and push to registry
        run: |
          ./gradlew bootBuildImage
        #docker push ghcr.io/joaomlneto/$IMAGE_NAME:$IMAGE_TAG
        env:
          MAVEN_REPOSITORY_USERNAME: ${{ github.actor }}
          MAVEN_REPOSITORY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_NAME: ${{ github.event.repository.name }}
          IMAGE_TAG: latest
